@model IEnumerable<SistemaResocentro.ViewModel.Mantenimiento.ConversacionesMantenimiento>
@{
    Layout = null;
}
<style>
    .panel-heading > .panel-title {
        padding: 3px 15px;
    }
</style>

<div class="panel-group joined" id="accordion-conversacion">
    @if (Model.Count() == 0)
    {
        <span>
            <i>
                No se registro ninguna conversacion.
            </i>
        </span>
    }
    @foreach (var item in Model)
    {

        <div class="panel panel-info">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a data-toggle="collapse" data-parent="#accordion-conversacion" href="#collapseOne-@item.idConversacion" class="collapsed">
                        <img src="~/images/profile.png" class="img-circle" style="width:30px;" /> @item.usuario - @item.fecha
                    </a>
                </h4>
            </div>
            <div id="collapseOne-@item.idConversacion" class="panel-collapse collapse">
                <div class="panel-body scrollable">
                    @Html.Raw(item.mensaje)

                </div>
            </div>
        </div>
    }

</div>

<div class="row">
    <div class="border-top" style="padding-top:5px;">
        <div class="col-sm-10">
            <div class="col-sm-5">
                <div class="form-group">
                    <label class="control-label ">Nombre a Mostrar</label>
                    <input id="usuario_msj" class="form-control" placeholder="Ingrese el nombre a mostrar" type="text" value="">
                </div>
            </div>
            <div class="col-sm-12">
                <div class="form-group">
                    <label class="control-label ">Mensaje </label>
                    <div class="compose-message-editor">

                        <textarea id="mailResponder" class="form-control wysihtml5"></textarea>
                    </div>
                    
                </div>
            </div>
        </div>
        <button class="btn btn-success col-sm-2" onclick="enviarMensaje();">Enviar &nbsp;<i class="fa fa-send"></i></button>
    </div>
</div>



<script type="text/javascript">
    $(function () {
        $('#mailResponder').wysihtml5();
        $('.scrollable').slimScroll({
            height: 150,
            alwaysVisible: false,
        });
    });
    function enviarMensaje() {
        var msj = htmlEscape($('#mailResponder').val());
        var usu = $("#usuario_msj").val();
        if (msj != "" && usu != "") {
            var Data = JSON.stringify({
                idConversacion: 0, idIncidente: idIncidente, usuario: usu, mensaje: msj, fecha: '01-01-1990'
            }, null, "");
            $.ajax({
                url: "/Mantenimiento/RegistrarConversacionIncidente",
                data: { data: Data },
                dataType: "json",
                type: "POST",
                error: function () {
                    toastr.error('Error al registrar conversación', 'Error', opts);
                },
                success: function (data) {
                    if (data) {
                        toastr.success('Se registró conversación', 'Éxito', opts);
                        $('#mailResponder').val("");
                        actualizarConversacion();
                    } else
                        toastr.error('Error al registrar conversación', 'Error', opts);
                }
            });
        }
        else {
            toastr.error('Verifique los campos:<ul> <li>Nombre a Mostrar</li><li>Mensaje</li> <ul>', 'Error', opts);
        }

    }

</script>