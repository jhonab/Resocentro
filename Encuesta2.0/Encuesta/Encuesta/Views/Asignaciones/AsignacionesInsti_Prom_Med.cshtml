@{
    ViewBag.Title = "<i class='fa fa-area-chart fa-lg'></i> Asignaciones";
    ViewBag.Titlenot = "Asignaciones";
}

<script src="~/js/plugins/dataTables/jquery.dataTables.js"></script>
<script src="~/js/plugins/dataTables/dataTables.bootstrap.js"></script>
<script src="~/js/jquery.autosize.js"></script>
<script src="~/js/getUrl.js"></script>

<script src="~/js/jquery-ui.min.js"></script>

<script type="text/javascript">

    var table;
    var myDate = new Date();
    

    $(document).ready(function () {
        //activacion del boton en el menu
        $(".sidebar > .sidebar-menu > li").removeClass("active");
        $(".sidebar > .sidebar-menu > li.p20").addClass("active");


        $("#msj").fadeOut()//ocultar el msj
        $('.animate').autosize();//autosizeTexbox
        e = $('#myDataTable').DataTable({
            "bServerSide": true,
            "sAjaxSource": "@Url.Action("ListaAsync", "Asignaciones")",
            //"bProcessing": true,
            "iDisplayLength": 20,
            "lengthMenu": [[20, 25, 50, -1], [20, 25, 50, "All"]],
            "aoColumns": [
                             { "sName": "C. Institución" },//0
                             { "sName": "Institución" },
                             { "sName": "C. Promotor" },
                             { "sName": "Promotor" },
                             { "sName": "CMP" },//1
                             { "sName": "Médico" },//2
                             { "sName": "Estado" },//3
                             {
                                 "sName": "Acciones",
                                 "mRender": function (data, type, full) {
                                     return "";
                                 }
                             }
            ],
            "createdRow": function (row, aData, dataIndex) {

                $('td:eq(7)', row ).append('<center><button type="button" onclick="Estado(' + aData[0] + ','+ aData[2] + ',' + aData[4] + ')" class="btn btn-success" >Cambiar Estado</button></center>');
            }
        });

        load_instituciones();
        load_promotores();
        load_medicos();

    });
        //function Cancelar(cli, pro, med) {
        //    $('#institucion').val(examen);
        //    $('#promotor').val(pro);
        //    $('#medico').val(med);
        //    $('#modal_Cancelar').modal('toggle');
        //}

  
    function Estado(insti, promo, med) {
        $.ajax({
            url: "@Url.Action("CambiarEstado", "Asignaciones")",
            data: { idcli: insti, idpro: promo, idmed: med },
            dataType: "json",
            type: "POST",

            error: function () {
                mostrarmensaje(4, 'Ocurrio un problema y <b>NO</b> se enviaron los datos al sistema');
            },
            success: function (data) {
                if (data == true) {
                    alert("Se Modificó Estado");
                    window.location.href = '@Url.Action("AsignacionesInsti_Prom_Med", "Asignaciones")';
                }
                else
                    alert("No se Modificó Estado");
            }
        });
    }

        function load_instituciones() {
            $.ajax({
                url: "@Url.Action("getinstituciones", "Asignaciones")",
                data: {},
                dataType: "json",
                type: "POST",
                error: function () {
                    alert("error cargar instituciones");
                },
                success: function (data) {
                    var items = "";
                    items += "<option value='' >--- Seleccione Institución ---</option>";
                    $.each(data, function (i, item) {
                        items += "<option value=\"" + item.Value + "\">" + item.Text + "</option>";
                    });
                    $("#lstinsti").html(items);

                }
            });
        }

        function load_promotores() {
            $.ajax({
                url: "@Url.Action("getpromotores", "Asignaciones")",
                data: {},
                dataType: "json",
                type: "POST",
                error: function () {
                    alert("error cargar promotores");
                },
                success: function (data) {
                    var items = "";
                    items += "<option value='' >--- Seleccione Promotor ---</option>";
                    $.each(data, function (i, item) {
                        items += "<option value=\"" + item.Value + "\">" + item.Text + "</option>";
                    });
                    $("#lstpromo").html(items);

                }
            });
        }

           

        function load_medicos() {

            $.ajax({
                url: "@Url.Action("getmedicos", "Asignaciones")",
                data: {},
            dataType: "json",
            type: "POST",
            error: function () {
                alert("error cargar médicos");
            },
            success: function (data) {
                var items = "";
                items += "<option value='' >--- Seleccione Médico ---</option>";
                $.each(data, function (i, item) {
                    items += "<option value=\"" + item.Value + "\">" + item.Text + "</option>";
                });
                $("#lstmed").html(items);

            }
        });
       
        }

    
</script>

<div class="row">
    <div class="col-lg-6">
        <div class="panel panel-default">
            <div class="panel-heading">
                Filtros
            </div>
            <div class="panel-body">
                @*@using (Html.BeginForm("RegistrarAsignación", "Asignaciones", FormMethod.Get))
                {*@
                    <script type="text/javascript">

    function validar() {
        var msj = "";
        if ($("#lstinsti").val() == "")
            msj += "- Seleccione una Institución \n";
        if ($("#lstpromo").val() == "")
            msj += "- Seleccione un Promotor \n";
        if ($("#lstmed").val() == "")
            msj += "- Seleccione un Médico \n";
        if (msj == "")
            guardarAsignacion();
        else {
            alert(msj);
            //return false;
        }
    }

    
    function guardarAsignacion() {

        var cod_cli = $("#lstinsti").val();
        var nom_cli = $("#lstinsti option:selected").html();
        var cod_pro = $("#lstpromo").val();
        var nom_pro = $("#lstpromo option:selected").html();
        var cmp_med = $('#lstmed').val();
        var nom_med = $("#lstmed option:selected").html();

        $.ajax({
            url: "@Url.Action("RegistrarAsignación", "Asignaciones")",
                                        data: { codcli: cod_cli, nomcli: nom_cli, codpro: cod_pro, nompro: nom_pro, cmpmed: cmp_med, nommed: nom_med },
                                    dataType: "json",
                                    type: "POST",
                                    error: function () {
                                        mostrarmensaje(4, 'Ocurrio un problema y <b>NO</b> se enviaron los datos al sistema');
                                    },
                                    success: function (data) {
                                        if (data == true) {
                                            //mostrarTecnica(idsedacion);
                                            $("#lstinsti").val("");
                                            $("#lstinsti option:selected").html();
                                            $("#lstpromo").val("");
                                            $("#lstpromo option:selected").html();
                                            $("#lstmed").val("");
                                            $("#lstmed option:selected").html();
                                            alert("Se regitro la Asignación");
                                            window.location.href = '@Url.Action("AsignacionesInsti_Prom_Med", "Asignaciones")';
                                        }
                                        else
                                            alert("No se registro la Asignación");
                                    }
                                });
                        }

                    </script>

                    <div class="form-group col-lg-6">
                        <label>Institución:</label>
                        <select id="lstinsti" name="lstinsti" class="form-control">
                            
                        </select>
                    </div>

                    <div class="form-group col-lg-6">
                        <label>Promotor:</label>
                        <select id="lstpromo" name="lstpromo" class="form-control">
                            
                        </select>
                    </div>

                <div class="form-group col-lg-6">
                    <label>Médico:</label>
                    <select id="lstmed" name="lstmed" class="form-control">
                        
                    </select>
                </div>
                <div class="form-group col-lg-6">
                    <input type="submit" value="Registrar Asignación" onclick="return validar();" class="btn btn-success" />
                </div>
                    @*}*@
                </div>

        </div>
    </div>

</div>

   <div class="row">
    <div class="col-lg-12">
        <div class="box box-primary">
            <div class="box-header">
                <h2 class="box-title">Asignaciones</h2>
            </div>
            <div class="box-body chart-responsive">
                
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        Lista
                    </div>

                    <!-- /.panel-heading -->
                    <div class="panel-body">
                        <div class="alert" id="msj">
                        </div>
                        <div class="row">
                            <div id="div_time" class="col-lg-12">
                            </div>
                        </div>
                        <br />
                        <div class="table-responsive">
                            <table id="myDataTable" class="table table-striped table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th width="auto">COD. INSTITUCIÓN</th>
                                        <th width="auto">INSTITUCIÓN</th>
                                        <th width="auto">COD. PROMOTOR</th>
                                        <th width="auto">PROMOTOR</th>
                                        <th width="auto">CMP MÉDICO</th>
                                        <th width="auto">MÉDICO</th>
                                        <th width="auto">ESTADO</th>
                                        <th width="auto"></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



    @*<div class="modal fade" id="modal_Cancelar" tabindex="-1" role="dialog" aria-labelledby="modal_CancelarLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="modal_ModalidadLabel">Confirmar Cancelación de Asignación</h4>
                </div>
                <div class="modal-body" id="_2">
                    <input type="text" id="institucion" name="institucion" />
                    <input type="text" id="promotor" name="promotor" />
                    <input type="text" id="medico" name="medico" />
                    @*<div class='form-group'>
                    <label>Motivo Cancelacion: </label>
                    <select id="ddlMotivos" class="form-control">
                        <option value="0">- seleccione motivo -</option>
                        <option value="1">Solicitud erronea</option>
                        <option value="2">Falta información del examen</option>
                        <option value="99">Otros</option>
                    </select>

                    <textarea class="form-control animate" id="txtmotivo" placeholder="Ingrese el motivo de cancelación"></textarea>
                </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-danger" onclick="Estado($('#institucion').val(), $('#promotor').val(), $('#medico').val())" data-dismiss="modal">Cancelar</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>*@

    @*<!-- Modal Buscar Examen-->
<div class="modal fade" id="modalSolucion" tabindex="-1" role="dialog" aria-labelledby="modalSolucionLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="modalSolucionLabel">Ingrese Número de Examen</h4>
            </div>
            <div class="modal-body" id="2">
                <div class="input-group custom-search-form">
                    <input type="number" class="form-control" id="modal_nexamen" placeholder="N° Examen...">
                    <span class="input-group-btn">
                        <button class="btn btn-default" type="button" onclick="EditExamen();">
                            <i class="fa fa-search"></i>
                        </button>
                    </span>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>*@

