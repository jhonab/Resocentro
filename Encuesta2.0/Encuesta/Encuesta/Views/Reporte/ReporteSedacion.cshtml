@model Encuesta.ViewModels.Reporte.DataReporteSedacion
@{
    ViewBag.Title = "<i class='fa fa-area-chart fa-lg'></i> Reporte Sedación";
    ViewBag.Titlenot = "Reporte Sedación";
}
<script src="~/js/plugins/dataTables/jquery-1.12.0.min.js"></script>
<script src="~/js/plugins/dataTables/jquery.dataTables.min.js"></script>
<link href="https://cdn.datatables.net/1.10.11/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/buttons/1.1.2/css/buttons.dataTables.min.css" rel="stylesheet">
<script src="https://cdn.datatables.net/tabletools/2.2.4/js/dataTables.tableTools.min.js">
</script>

<script type="text/javascript">
    $(document).ready(function () {


        $('#table_resumen').dataTable();

        function exportTableToCSV1($table, filename, cabecera) {
            var $rows = $table.find('tr:has(td)'),
                // Temporary delimiter characters unlikely to be typed by keyboard
                // This is to avoid accidentally splitting the actual contents
                tmpColDelim = String.fromCharCode(11), // vertical tab character
                tmpRowDelim = String.fromCharCode(0), // null character

                // actual delimiter characters for CSV format
                colDelim = '","',
                rowDelim = '"\r\n"',

                // Grab text from table into CSV formatted string
                csv = cabecera + $rows.map(function (i, row) {
                    var $row = $(row),
                        $cols = $row.find('td');

                    return $cols.map(function (j, col) {
                        var $col = $(col),
                            text = $col.text();

                        return text.replace(/"/g, '""'); // escape double quotes

                    }).get().join(tmpColDelim);

                }).get().join(tmpRowDelim)
                    .split(tmpRowDelim).join(rowDelim)
                    .split(tmpColDelim).join(colDelim) + '"',

                // Data URI

                 csvData = 'data:application/csv;charset=utf-8,' + encodeURIComponent(csv);

            $(this)
                    .attr({
                        'download': filename,
                        'href': csvData,
                        'target': '_blank'
                    });

        }

        $(".exportar").on('click', function (event) {
            var table = this.getAttribute("tabla");
            var insumo = this.getAttribute("insumo");
            exportTableToCSV1.apply(this, [$('#' + table), insumo + '.csv', '"\"Fecha Atencion\,"\"Fecha Sedacion\,"\"Sede\,"\"Nro Examen\,"\"Paciente\,"\"Edad\,"\"Peso\,"\"Estudio\,"\"Estado\,"\"Equipo\,"\"Anestesiólogo\,"\"Tipo Sedacion\,"\"Motivo\,"\"Otros\,"\"Producto\,"\"Cantidad\,"\"Frasco,"\"Aplicado' + '\r\n"']);
            // IF CSV, don't do event.preventDefault() or return false
            // We actually need this to be a typical hyperlink
        });
    });
</script>

<div class="row">
    <div class="col-lg-6">
        <div class="panel panel-default">
            <div class="panel-heading">
                Filtro de Fecha
            </div>
            <div class="panel-body">


                @using (Html.BeginForm("ReporteSedacion", "Reporte", FormMethod.Get))
                {
                    <script type="text/javascript">

                        function validar() {
                            var msj = "";
                            if ($("#i").val() == "")
                                msj += "- Ingrese la fecha de inicio \n";
                            if ($("#f").val() == "")
                                msj += "- Ingrese la fecha de termino \n";

                            if (msj == "")
                                return true;
                            else {
                                alert(msj);
                                return false;
                            }
                        }
                    </script>

                    <div class="form-group col-lg-6">
                        <label>Inicio:</label>
                        <input type="date" id="i" name="i" class="form-control" />
                    </div>
                    <div class="form-group col-lg-6">
                        <label>Termino:</label>
                        <input type="date" id="f" name="f" class="form-control" />
                    </div>

                    <input type="submit" value="Buscar" onclick="return validar();" class="btn btn-outline btn-success" />
                }
            </div>

        </div>
    </div>

</div>

<div class="row">
    <div class="col-sm-12">

        @foreach (var item in Model.detalle.Select(x => x.sede).Distinct().ToList())
        {
            
            var nombretabla = "tabla_" + item;

            var lista = Model.detalle.Where(x => x.sede == item).ToList();
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h4 class="panel-title">
                        <a data-toggle="collapse1" data-parent="#accordion1" href="#collapse1_@item">@item </a>
                    </h4>
                    <a href="#" tabla="@nombretabla" insumo="@item" class="btn btn-primary pull-right exportar">Export Detalle</a>
                </div>

                <div class="panel-body">
                    <table id="@nombretabla" class="table-data table table-striped table-bordered table-hover ">
                        <thead>
                            <tr>

                                <th>
                                    Fec. Atención
                                </th>
                                <th>
                                    Fec. Sedación
                                </th>
                                <th>
                                    Sede
                                </th>
                                <th>
                                    N° Examen
                                </th>
                                <th>
                                    Paciente
                                </th>
                                <th>
                                    Edad
                                </th>
                                <th>
                                    Peso
                                </th>
                                <th>
                                    Estudio
                                </th>
                                <th>
                                    Estado
                                </th>
                                <th>
                                    Equipo
                                </th>
                                <th>
                                    Anestesiólogo
                                </th>
                                <th>
                                    Tipo Sedación
                                </th>
                                <th>
                                    Motivo
                                </th>
                                <th>
                                    Otros
                                </th>
                                <th>
                                    Producto
                                </th>
                                <th>
                                    Cantidad
                                </th>
                                <th>
                                    N° Frasco
                                </th>
                                <th>
                                    Aplicado
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item1 in lista)
                            {
                                <tr>
                                    <td>@item1.fecha</td>
                                    <td>@item1.fec_aplica</td>
                                    <td>@item1.sede </td>
                                    <td>@item1.codigo </td>
                                    <td>@item1.paciente </td>
                                    <td>@item1.edad  </td>
                                    <td>@item1.peso   </td>
                                    <td>@item1.nombreestudio </td>
                                    <td>@item1.estadoestudio </td>
                                    <td>@item1.equipo  </td>
                                    <td>@item1.anestecia  </td>
                                    <td>@item1.tipo_seda  </td>
                                    <td>@item1.motivo_seda  </td>
                                    <td>@item1.otros_seda  </td>
                                    <td>@item1.producto  </td>
                                    <td style="text-align:right">@item1.cantidad ml </td>
                                    <td style="text-align:right">@item1.lote  </td>
                                    <td style="text-align:right">@item1.aplicado  </td>
                                </tr>
                            }
                        </tbody>
                    </table>

                </div>
            </div>



        }


    </div>
</div>


<div class="row">
    <div class="col-sm-12">
        <div class="panel panel-primary">
            <div class="panel-heading">
                Resumen - Reporte Sedación
            </div>
            <div class="panel-body">
                <div class="row">
                    <div class="col-md-11">
                        <table id="table_resumem" class="table table-striped table-bordered table-hover table">
                            <thead>
                                <tr>
                                    <th>
                                        Insumo
                                    </th>
                                    <th>
                                        Frascos Salida
                                    </th>
                                    <th>
                                        U. Medida Salida
                                    </th>
                                    <th>
                                        Frascos Usados
                                    </th>
                                    <th>
                                        U. Medida Usados
                                    </th>
                                    <th>
                                        Frascos Saldo
                                    </th>
                                    <th>
                                        U. Medida Saldo
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.resumen)
                                {
                                    <tr>
                                        <td>@item.insumo</td>
                                        <td>@item.frascoSalida </td>
                                        <td>@item.umedidaSalida </td>
                                        <td>@item.frascoUsado </td>
                                        <td>@item.umedidaUsado  </td>
                                        <td>@item.frascoSaldo   </td>
                                        <td>@item.umedidaSaldo </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

