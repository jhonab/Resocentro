@model Encuesta.ViewModels.Reporte.ReporteViewModel

@{
    ViewBag.Title = "<i class='fa fa-line-chart'></i> Reporte Tecnólogos";
    ViewBag.Titlenot = "Reporte Tecnólogos";
}

<!-- DataTables JavaScript -->
<script src="~/js/plugins/dataTables/jquery.dataTables.js"></script>
<script src="~/js/plugins/dataTables/dataTables.bootstrap.js"></script>
<script src="~/js/plugins/KendoChart/kendo.all.min.js"></script>
<link href="~/css/plugins/Kendochart/kendo.dataviz.min.css" rel="stylesheet" />

<script type="text/javascript">
    $(document).ready(function () {

        load_tecnologos();
        load_equipos();

        function exportTableToCSV1($table, filename, cabecera) {

            var $rows = $table.find('tr:has(td)'),
                // Temporary delimiter characters unlikely to be typed by keyboard
                // This is to avoid accidentally splitting the actual contents
                tmpColDelim = String.fromCharCode(11), // vertical tab character
                tmpRowDelim = String.fromCharCode(0), // null character

                // actual delimiter characters for CSV format
                colDelim = '","',
                rowDelim = '"\r\n"',

                // Grab text from table into CSV formatted string
                csv = cabecera + $rows.map(function (i, row) {
                    var $row = $(row),
                        $cols = $row.find('td');

                    return $cols.map(function (j, col) {
                        var $col = $(col),
                            text = $col.text();

                        return text.replace(/"/g, '""'); // escape double quotes

                    }).get().join(tmpColDelim);

                }).get().join(tmpRowDelim)
                    .split(tmpRowDelim).join(rowDelim)
                    .split(tmpColDelim).join(colDelim) + '"',

                // Data URI

                 csvData = 'data:application/csv;charset=utf-8,' + encodeURIComponent(csv);

            $(this)
                    .attr({
                        'download': filename,
                        'href': csvData,
                        'target': '_blank'
                    });

        }
        $("#btnExportDetalle").on('click', function (event) {
            // CSV
            exportTableToCSV1.apply(this, [$('#tabla_adquisicion'), 'Reporte_Tecnologos.csv', '"\"Revisado\,"\"Fecha\,"\"Examen\,"\"Paciente\,"\"Modalidad\,"\"Estudio\,"\"Equipo\,"\"Placas\,"\"Imagenes\,"\"Postproceso\,"\"Sedacion\,"\"Contraste\,"\"Encuestador\,"\"Supervisor\,"\"Duracion,"\"Tecnologo' + '\r\n"']);

        });

    
        function load_tecnologos() {
            $.get(
                  '@Url.Action("gettecnologos", "Reporte")'
               )
              .done(function (data) {
                  $.each(data, function (i, row) {
                      var $option = $('<option>');
                      $option.val(row.codigousuario);
                      $option.html(row.ShortName);
                      $('#tecno').append($option);
                  })
              })
              .fail(function (data) {
                  console.log('error !!!');
              }
          );
        }

        function load_equipos() {
            $.get(
                  '@Url.Action("getequipos", "Reporte")'
               )
              .done(function (data) {
                  $.each(data, function (i, row) {
                      var $option = $('<option>');
                      $option.val(row.codigoequipo);
                      $option.html(row.nombreequipo);
                      $('#equipo').append($option);
                  })
              })
              .fail(function (data) {
                  console.log('error !!!');
              }
          );
        }

    });
</script>
<div class="row">
    <div class="col-lg-12">
        <div class="box box-primary">
            <div class="box-header">

                <h2 class="box-title">Usuario:  @Membership.GetUser().UserName</h2>
            </div>
            <div class="box-body chart-responsive">


                <div class="row">
                    <div class="col-lg-6">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                Filtros
                            </div>
                            <div class="panel-body">
                                @using (Html.BeginForm("ReporteTecnologos", "Reporte", FormMethod.Get))
                                {
                                    <script type="text/javascript">
                                        function validar() {
                                            var msj = "";
                                            if ($("#i").val() == "")
                                                msj += "- Ingrese la fecha de inicio \n";
                                            if ($("#f").val() == "")
                                                msj += "- Ingrese la fecha de termino \n";
                                            if ($("#tecno").val() == "")
                                                msj += "- Seleccione Tecnólogo \n";
                                            if ($("#equipo").val() == "")
                                                msj += "- Seleccione Equipo \n";
                                            if (msj == "")
                                                return true;
                                            else {
                                                alert(msj);
                                                return false;
                                            }
                                        }
                                    </script>
                                    <div class="form-group col-lg-6">
                                        <label>Inicio:</label>
                                        <input type="date" id="i" name="i" class="form-control" />
                                    </div>
                                    <div class="form-group col-lg-6">
                                        <label>Termino:</label>
                                        <input type="date" id="f" name="f" class="form-control" />
                                    </div>
                                    <div class="form-group col-lg-6">
                                        <label>Tecnólogos:</label>
                                        <select id="tecno" name="tecno" class="form-control">
                                            <option value="">--- Seleccione ---</option>
                                            <option value="%">Todos</option>
                                        </select>
                                    </div>
                                    <div class="form-group col-lg-6">
                                        <label>Equipos:</label>
                                        <select id="equipo" name="equipo" class="form-control">
                                            <option value="">--- Seleccione ---</option>
                                            <option value="%">Todos</option>
                                        </select>
                                    </div>

    <div class="form-group col-lg-6">
        <label>Revisados:</label>
        <select id="rev" name="rev" class="form-control">
            <option value="">--- Seleccione ---</option>
            <option value="1">SI</option>
            <option value="0">NO</option>
            <option value="%">TODOS</option>
        </select>
    </div>

                                    <div class="form-group col-lg-6">
                                        <input type="submit" value="Buscar" onclick="return validar();" class="btn btn-outline btn-success" />
                                    </div>
                                }
                            </div>

                        </div>
                    </div>
                </div>

                <div class="panel panel-primary">

                    <!-- .panel-heading -->
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="panel-group" id="accordion">

                                    @if (Model.tecnologo != null && Model.tecnologo.Count > 0)
                                    {
                                        <script>
                                            var tabla_tecnologo;
                                            var url;
                                            var pac;
                                            $(document).ready(function () {
                                                tabla_tecnologo = $('.tecnologo').DataTable();
                                                $('#tabla_adquisicion tbody').on('contextmenu', 'td', function (e) {
                                                    var rowIdx = tabla_tecnologo
                                                        .cell(this)
                                                        .index().row;
                                                    var imagen = (tabla_tecnologo.cell(rowIdx, 8).data());

                                                    if (!(imagen.indexOf("checked") >= 0)) {
                                                        var items = "";
                                                        var examen = (tabla_tecnologo.cell(rowIdx, 2).data());
                                                        pac = (tabla_tecnologo.cell(rowIdx, 3).data()).split(" ");
                                                        url = "http://xero.resocentro.com/#PatientName=" + pac[0] + "&StudyDateTime=Today"
                                                        var modalidad = (tabla_tecnologo.cell(rowIdx, 4).data());
                                                        if (modalidad != "")
                                                            url = "http://xero.resocentro.com/#PatientName=" + pac[0] + "&StudyDateTime=Today&ModalitiesInStudy=" + modalidad;
                                                        items += '<li><a tabindex="-1" href="javascript:buscarImpax(' + examen + ');"><i class="fa fa-search fa-lg " style="color: #078EF8"></i>&nbsp;&nbsp;Buscar en Impax</a></li>'

                                                        $("#contextMenu").html(items);
                                                        $("#contextMenu").css({
                                                            display: "block",
                                                            left: e.pageX,
                                                            top: e.pageY
                                                        });
                                                    }
                                                    $(document).click(function () {
                                                        $("#contextMenu").hide();
                                                    });
                                                    return false;
                                                });
                                            });
                                            function buscarImpax(codigo) {
                                                //$("#num_examen").val(codigo);
                                                //$("#patientid").val("");
                                                //$("#pac_nombre").val(pac[0]);
                                                //$("#studies").val("");
                                                //$('#myModal').modal("show")
                                                window.open(url, '_blank');
                                            }
                                        </script>
                                        <div class="panel panel-info">
                                            <div class="panel-heading">
                                                <h4 class="panel-title" style="height:36px!important;">
                                                    <a data-toggle="collapse" data-parent="#accordion" href="#collapseTecnologo">Tecnólogo</a>
                                                    <label class="pull-right">
                                                        <i>No Impax: @Model.tecnologo.Where(x => x.imagenes == false).Count()</i>&nbsp;&nbsp;
                                                        <i>Total: @Model.tecnologo.Count()</i>&nbsp;&nbsp;
                                                        <i>Revisadas: @Model.tecnologo.Where(x => x.isRevisado == true).Count()</i>&nbsp;&nbsp;
                                                        @*@if (Model.isRevisado)
                                                        {
                                                            <a href="@Url.Action("CerrarTurno","Reporte")" class="btn btn-primary">Revisadas</a>
                                                        }*@
                                                    </label>
                                                </h4>
                                            </div>
                                            <div id="collapseTecnologo" class="panel-collapse collapse">
                                                <div class="panel-body">

                                                    <div class="panel panel-primary">
                                                        <div class="panel-heading">
                                                            Adquisiciones
                                                            <a href="#" id="btnExportDetalle" class="btn btn-primary pull-right">Exportar Detalle</a>
                                                        </div>
                                                        <div class="panel-body">
                                                            <table class="table table-striped table-bordered table-hover tecnologo" id="tabla_adquisicion">
                                                                <thead>
                                                                    <tr>
                                                                        <th>
                                                                            Revisado
                                                                        </th>
                                                                        <th>
                                                                            Fecha
                                                                        </th>
                                                                       
                                                                        <th>
                                                                            Examen
                                                                        </th>
                                                                        <th>
                                                                            Paciente
                                                                        </th>
                                                                        <th>
                                                                            Mod.
                                                                        </th>
                                                                        <th>
                                                                            Estudio
                                                                        </th>
                                                                        <th>
                                                                            Equipo
                                                                        </th>
                                                                        <th>
                                                                            Placas
                                                                        </th>
                                                                        <th>
                                                                            Imagenes
                                                                        </th>
                                                                        <th>
                                                                            PostProceso
                                                                        </th>
                                                                        <th>
                                                                            Sedacion
                                                                        </th>
                                                                        <th>
                                                                            Contraste
                                                                        </th>
                                                                        <th>
                                                                            Encuestador
                                                                        </th>
                                                                        <th>
                                                                            Supervisor
                                                                        </th>
                                                                        <th>
                                                                            Duración
                                                                        </th>
                                                                        <th>
                                                                            Tecnólogo
                                                                        </th>
                                                                        @*<th></th>*@
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    @foreach (var item in Model.tecnologo)
                                                                    {
                                                                        <tr>
                                                                            <td class="table_id" style="text-align: center;">
                                                                                @Html.DisplayFor(modelItem => item.isRevisado)
                                                                            </td>
                                                                            <td class="table_id">
                                                                                @Html.DisplayFor(modelItem => item.fecha)
                                                                            </td>
                                                         
                                                                            <td>
                                                                                @Html.DisplayFor(modelItem => item.examen)
                                                                            </td>
                                                                            <td>
                                                                                @Html.DisplayFor(modelItem => item.paciente)
                                                                            </td>
                                                                            <td>
                                                                                @Html.DisplayFor(modelItem => item.modalidad)
                                                                            </td>
                                                                            <td>
                                                                                @Html.DisplayFor(modelItem => item.estudio)
                                                                            </td>
                                                                            <td>
                                                                                @Html.DisplayFor(modelItem => item.equipo)
                                                                            </td>
                                                                            <td style="text-align: center;">
                                                                                @Html.DisplayFor(modelItem => item.placas)
                                                                            </td>
                                                                            <td style="text-align: center;">
                                                                                @Html.DisplayFor(modelItem => item.imagenes)
                                                                            </td>
                                                                            <td style="text-align: center;">
                                                                                @Html.DisplayFor(modelItem => item.postproceso)
                                                                            </td>
                                                                            <td style="text-align: center;">
                                                                                @Html.DisplayFor(modelItem => item.sedacion)
                                                                            </td>
                                                                            <td style="text-align: center;">
                                                                                @Html.DisplayFor(modelItem => item.contraste)
                                                                                @if (item.continuo)
                                                                                {
                                                                                    @Html.DisplayFor(modelItem => item.continuo)
                                                                                }
                                                                            </td>
                                                                            <td>
                                                                                @Html.DisplayFor(modelItem => item.encuestador)
                                                                            </td>
                                                                            <td>
                                                                                @Html.DisplayFor(modelItem => item.supervisor)
                                                                            </td>
                                                                            <td>
                                                                                @{ TimeSpan ts = item.tec_fin - item.tec_ini;
                                                                                <text>
                                                                                    @ts.Minutes
                                                                                    .min
                                                                                </text>
                                                                                }
                                                                            </td>
                                                                            <td>
                                                                                @Html.DisplayFor(modelItem => item.tecno)
                                                                            </td>
                                                                            @* <td class="table_id">

                                                                                </td>*@
                                                                        </tr>
                                                                    }

                                                                </tbody>
                                                            </table>

                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }


                                </div>

                            </div>
                        </div>
                    </div>
                    <!-- .panel-body -->
                </div>
            </div>
        </div>
    </div>

</div>
<ul id="contextMenu" class="dropdown-menu" role="menu" style="display:none"></ul>


<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Actualizar Link de Imagenes</h4>
            </div>
            <div class="modal-body">
                <script type="text/javascript">
                    $(function () {
                        $("#patientid").change(generarLink);
                        $("#studies").change(generarLink);
                    });
                    function generarLink() {
                        var texto = $("#patientid").val();
                        var studi = $("#studies").val();
                        var _paci = $("#pac_nombre").val();
                        if (texto != "" && studi != "") {
                            var _url = 'http://xero.resocentro.com/#tab=Display&PatientName=' + _paci + '&PatientID=' + texto + '&studies=' + studi;

                            $("#link").html('<a target="_blank" href="' + _url + '">Link Impax</a>');
                        }
                        else
                            $("#link").html("");
                    }
                </script>
                <input type="hidden" id="num_examen" />
                <input type="hidden" id="pac_nombre" />
                <div class="form-group">
                    <label>PatientID:</label>
                    <input type="text" id="patientid" class="form-control" />
                </div>
                <div class="form-group">
                    <label>Studies:</label>
                    <input type="text" id="studies" class="form-control" />
                </div>
                <div class="form-group">
                    <label id="link"></label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary">Actualizar</button>
            </div>
        </div>
    </div>
</div>
