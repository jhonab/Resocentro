@model Encuesta.ViewModels.Encuesta.Tipos.EncuestaAmpliacionViewModel

@{
    ViewBag.Title = "<i class='fa fa-edit'></i> Encuesta";
    ViewBag.Titlenot = "Encuesta Ampliación";
}


<script src="~/js/encuestas/encuestas_ini.js"></script>
<link href="~/css/Encuesta.css" rel="stylesheet" />
<script src="../js/jquery.autosize.js"></script>
<script src="~/js/jquery-ui.min.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        $('.animate').autosize();
    });
</script>
<div class="row" id="div_PreEntrevista">
    <div class="col-lg-12">
        <div class="box box-primary">
            <div class="box-header">
                @{string tipo_encuesta = "Ampliación";
                }
                <h1 class="box-title titulo_ocultar">
                    ENCUESTA @tipo_encuesta.ToUpper()

                </h1>
            </div>
            <div class="box-body chart-responsive">
                @*Datos Examen*@
                <div class="row">

                    <div class="col-lg-12">

                        <div class="box box-solid box-primary">
                            <div class="box-header">
                                <h3 class="box-title">Datos Examen</h3>
                                <div class="box-tools pull-right">
                                    <button class="btn btn-primary btn-sm" data-widget="collapse"><i class="fa fa-minus"></i></button>
                                </div>
                            </div>
                            <div class="box-body">
                                <div class="row">
                                    <div class="col-lg-12">

                                        <div class="col-xs-5 col-sm-5 col-lg-5">
                                            @Html.Partial("_DatosExamen", Model._examen)
                                        </div>
                                        <div class="col-xs-5 col-sm-5 col-lg-5">
                                            @Html.Partial("_DatosPaciente", Model._paciente)
                                        </div>

                                        <div class="col-xs-2 col-sm-2 col-lg-2">
                                            <div class="btn-group-vertical">
                                                <button class="btn btn-primary box-tools pull-right no-print" onclick="cambiarEncuesta()">
                                                    <i class="fa fa-undo fa-2x"></i>
                                                </button>
                                                <button class="btn btn-info box-tools pull-right no-print" onclick="verHistorial('@Model._examen.codigo')">
                                                    <i class="fa fa-history fa-2x"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>
                <div class="row" id="div_historial">
                </div>
                @using (Html.BeginForm(null, null, FormMethod.Post, new { id = "frm_encuesta" }))
                {
                    @Html.AntiForgeryToken()
                    @Html.ValidationSummary(true)

                    @Html.HiddenFor(y => y.numeroexamen);
                    @Html.HiddenFor(y => y.equipoAsignado);

                    <script type="text/javascript">
                        var isExamen_valido = false;
                        function validarExamen(paciente) {
                            $(".no_encuesta").remove();
                            var _nexam = $("#origen_examen").val();
                            if (_nexam != "" && _nexam > 0) {
                                $.ajax({
                                    url: "@Url.Action("ValidarAmpliacion", "RealizarEncuesta")",
                                    data: { examen: _nexam, paciente: paciente },
                                    dataType: "json",
                                    type: "POST",
                                    error: function () {
                                        mostrarmensaje(4, 'Error al mostrar los cambios realizados');
                                    },
                                    success: function (data) {
                                        if (data.result) {
                                            isExamen_valido = true;
                                            $("#origen_examen").parent().parent().append("<p class='no_encuesta alert-success'><i class='fa fa-check'></i> Examen correcto</p>");
                                            $("#div-motivo-amp").load("/RealizarEncuesta/getinfoAmpliacion?examen=" + _nexam, function (response, status, xhr) {
                                                if (status == "error") {
                                                    mostrarmensaje(4, 'Error:\n' + xhr.status + " " + xhr.statusText);
                                                }

                                            });
                                        } else {
                                            isExamen_valido = false;
                                            $("#origen_examen").parent().parent().append("<p class='no_encuesta alert-danger'><i class='fa fa-times'></i> Examen incorrecto por que no se solicito la ampliacion</p>");
                                        }
                                    }
                                });
                            } else {
                                alert("Ingrese el número de examen");
                            }
                        }
                    </script>
                    <div class="row">

                        <div class="col-lg-12">
                            <div class="box box-solid box-info">
                                <div class="box-header">
                                    <h3 class="box-title">Examen Previo</h3>
                                    <div class="box-tools pull-right">
                                        <button class="btn btn-info btn-sm" data-widget="collapse"><i class="fa fa-minus"></i></button>
                                    </div>
                                </div>
                                <div class="box-body">
                                    <div class="row">
                                        <div class="col-lg-12">
                                            <div class="col-sm-3 col-lg-3">
                                                <div class="form-group">
                                                    <label>N° Examen:</label>
                                                    @Html.TextBoxFor(model => model.origen_examen, new { @placeholder = "Examen", @type = "number", @min = "0", @class = "form-control" })
                                                </div>
                                            </div>
                                            <div class="col-sm-1 col-lg-1">
                                                <div class="form-group">
                                                    <label></label>
                                                    <button type="button" class=" btn btn-success" onclick="validarExamen('@Model._paciente.codigopaciente')"><i class="fa fa-check"></i>&nbsp;&nbsp; Validar&nbsp;&nbsp; </button>

                                                </div>
                                            </div>

                                            <div id="div-motivo-amp"></div>
                                        </div>
                                        @*<div class="col-lg-12">
                                                <div class="form-group">
                                                    @Html.CheckBoxFor(model => model.isInformeAmpliatorio) Informe Ampliatorio
                                                </div>
                                            </div>*@
                                    </div>
                                    

                                </div>
                            </div>
                        </div>
                    </div>

                }

                <div class="col-lg-12">
                    <a type="button" style="margin-left: 15px;" class="btn btn-defalt btn-lg no-print" href="@Url.Action("ListaEspera", "RealizarEncuesta", new {sede=Model._examen.codigoestudio.Substring(0,3) })"><i class="fa fa-arrow-circle-left fa-lg"></i>Retroceder</a>
                    <div class="pull-right">
                        <button type="button" style="margin-left: 15px;" class="btn btn-primary btn-lg no-print" onclick="reasignar('@Model._examen.codigo');">Finalizar&nbsp;<i class="fa fa-arrow-circle-right fa-lg"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


@*CAMBIO DE ENCUESTA*@
<script type="text/javascript">
    function cambiarEncuesta() {
        var modalidad = '@Model.modalidad';
        if (modalidad == 'RM') {
            $("#modalidad_RM").show();
            $("#modalidad_TEM").hide();
        } else {
            $("#modalidad_RM").hide();
            $("#modalidad_TEM").show();
        }
        $('#myModal').modal('toggle');
    }

    function realizarEncuesta(tipo) {
        var exa = '@Model._examen.codigo';
        window.location.href = ('@Url.Action("setEncuesta", "RealizarEncuesta")' + '?examen=' + exa + '&encuesta=' + tipo);
    }
</script>
<div class="modal fade " id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">Cambiar Encuesta</h4>
            </div>
            <div class="modal-body">
                <div id="div_select_examen">

                    @Html.Partial("_SeleccionExamen")
                </div>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>

@*ASIGNACION DE EXAMEN*@
<script type="text/javascript">

    function asignarModalidad(examen) {
        var _equipo = $("#cboequipo_asignar").val();
        if (_equipo != "") {
            $("#equipoAsignado").val(_equipo);
            $("#frm_encuesta").submit();
        }
        else
            alert("Seleccione un Equipo");
    }

    function reasignar(examen) {
        if (isExamen_valido) {
            $("#lbln_exam").val(examen)
            $.ajax({
                url: "@Url.Action("getEquipo", "VisorCarga")",
                data: { examen: examen },
                dataType: "json",
                type: "POST",
                error: function () {
                    alert("Error al cargar Equipo");
                },
                success: function (data) {
                    var items = "";
                    items += "<option value='' >- Seleccione -</option>";
                    $.each(data, function (i, item) {
                        items += "<option value=\"" + item.Value + "\">" + item.Text + "</option>";
                    });
                    $("#cboequipo_asignar").html(items);
                }
            });
            $('#AsignarModal').modal('toggle');
        } else {
            alert("Ingrese el número de examen")
        }
    }
</script>
<div class="modal" id="AsignarModal" tabindex="-1" role="dialog" aria-labelledby="AsignarModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title" id="AsignarModalLabel">Reasignar Examen a Equipo</h4>
            </div>
            <div class="modal-body">
                <input type="hidden" id="lbln_exam" />
                @Html.Partial("_AsignarEquipo")
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="asignarModalidad($('#lbln_exam').val());">Enviar</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
